#!/usr/bin/env node

var glob = require("glob")
var fs = require('fs');
var argv = require('minimist')(process.argv);

//Rewriting esprima dependency to espree, which supports es6
var rewire = require("rewire");
var Extractor = rewire('angular-gettext-tools/lib/extract');
Extractor.__set__("esprima", require('espree'));

if (!argv.dest) {
  throw 'dest parameter missed';
}

var gettextExtractor = new Extractor({
    markerName: argv['marker-name']
});


glob(argv.files, null, function (err, fileNames) {
    if (err) {
        throw err;
    }
    fileNames.forEach(function (filename) {
        var content = fs.readFileSync(filename, 'utf8');

        gettextExtractor.parse(filename, content);
    });
}).on('end', function finish(fileNames) {
    console.log('Finished parsing ' + argv.files +', read '+fileNames.length+' files.');

    fs.writeFile(argv.dest, gettextExtractor.toString(), null, function (err) {
      if (err){
        throw err;
      }
      console.log('All files processed, stored in a file ' + argv.dest);
    });
});
